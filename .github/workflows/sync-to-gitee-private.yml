name: Sync GitHub to Gitee Private

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      sync_all_branches:
        description: Also push all branches to Gitee private
        required: false
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: sync-gitee-private
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Gitee Private
        env:
          GITEE_PRIVATE_USER: ${{ secrets.GITEE_PRIVATE_USER }}
          GITEE_PRIVATE_TOKEN: ${{ secrets.GITEE_PRIVATE_TOKEN }}
          GITEE_REMOTE_HOST_PATH: z.gitee.cn:443/web-competition/RISE-RL.git
          SYNC_ALL_BRANCHES: ${{ inputs.sync_all_branches }}
          GIT_TERMINAL_PROMPT: 0
        run: |
          set -euo pipefail

          if [ -z "${GITEE_PRIVATE_USER:-}" ] || [ -z "${GITEE_PRIVATE_TOKEN:-}" ]; then
            echo "Missing secrets: GITEE_PRIVATE_USER / GITEE_PRIVATE_TOKEN"
            exit 1
          fi

          if [[ "${GITEE_PRIVATE_USER}" == http* ]] || [[ "${GITEE_PRIVATE_USER}" == */* ]]; then
            echo "GITEE_PRIVATE_USER should be plain username only, for example: Tianhe"
            exit 1
          fi

          echo "Checking network reachability to z.gitee.cn:443 ..."
          if ! timeout 20s bash -lc 'curl -fsS --connect-timeout 10 --max-time 20 https://z.gitee.cn/ >/dev/null'; then
            echo "Cannot reach z.gitee.cn from GitHub-hosted runner."
            echo "If z.gitee.cn is intranet-only, use a self-hosted runner in your internal network."
            exit 1
          fi

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          GITEE_REMOTE_URL="https://${GITEE_REMOTE_HOST_PATH}"
          AUTH_HEADER="Authorization: Basic $(printf '%s:%s' "${GITEE_PRIVATE_USER}" "${GITEE_PRIVATE_TOKEN}" | base64 | tr -d '\n')"

          if git remote get-url gitee-private >/dev/null 2>&1; then
            git remote set-url gitee-private "${GITEE_REMOTE_URL}"
          else
            git remote add gitee-private "${GITEE_REMOTE_URL}"
          fi

          echo "Checking authenticated access to repository ..."
          if ! timeout 60s git -c http.extraheader="${AUTH_HEADER}" ls-remote gitee-private >/dev/null 2>&1; then
            echo "Authenticated access check failed. Please verify:"
            echo "1) GITEE_PRIVATE_USER is correct login name."
            echo "2) GITEE_PRIVATE_TOKEN is valid and has repository write permission."
            echo "3) Repository path exists: ${GITEE_REMOTE_HOST_PATH}"
            exit 1
          fi

          if ! timeout 180s git -c http.extraheader="${AUTH_HEADER}" push gitee-private main 2>&1; then
            echo "Push main failed. Check token permission and network access."
            exit 1
          fi

          if ! timeout 180s git -c http.extraheader="${AUTH_HEADER}" push gitee-private --tags 2>&1; then
            echo "Push tags failed. Check token permission."
            exit 1
          fi

          if [ "${SYNC_ALL_BRANCHES:-false}" = "true" ]; then
            if ! timeout 300s git -c http.extraheader="${AUTH_HEADER}" push gitee-private --all 2>&1; then
              echo "Push all branches failed."
              exit 1
            fi
          fi
